# Домашнее задание № 1

## 1. Тема и целевая аудитория

### 1.1. Тема 
Twitch [[1](https://ru.wikipedia.org/wiki/Twitch)] - видеостриминговый сервис, специализирующийся на тематике компьютерных игр, в том числе трансляциях геймплея и киберспортивных турниров. Видео на платформе Twitch можно просматривать как в реальном времени, так и по запросу. Twitch принадлежит Twitch Interactive — дочерней компании Amazon.

### 1.2 . Целевая аудитория 
В августе количество поситителей превысило отметку в 1.2 миллиарда посетителей в месяц, это примерно 40 миллионов посетителей в день. [[2](https://www.similarweb.com/ru/website/twitch.tv/#traffic)]
Целевая аудитория согласно [[тык](https://www.similarweb.com/ru/website/twitch.tv/#geography)] по количеству поситителей:
1. Соединённые штаты - 20.48%
2. Германия - 6.54%
3. Республика Корея - 5.09%
4. Россия - 4.70%
5. Франция - 4.27%

### 1.3. MVP
* Просмотр онлайн трансляций
* Чат закреплённый к трансляции
* Платная и бесплатная подписка на канал
* Авторизация пользователей

## 2. Расчёт нагрузки

### 2.1. Продуктовые метрики 
* Месячная аудитория - 1.2 млрд [[2](https://www.similarweb.com/ru/website/twitch.tv/#traffic)]
* Суточная аудитория - 40 млн [[2](https://www.similarweb.com/ru/website/twitch.tv/#traffic)]
* Среднее время, проведенное на веб-сайте - 00:08:51 [[2](https://www.similarweb.com/ru/website/twitch.tv/#traffic)]
* Среднее количество страниц за визит - 4.48 [[2](https://www.similarweb.com/ru/website/twitch.tv/#traffic)]
* Активная аудитория в месяц - 140 млн [[10](https://earthweb.com/twitch-statistics/)] 

Согласно [статистике просмотров](https://streamscharts.com/overview) за прошлый месяц среднее количество просмотров в день было около 2.6 миллионов зрителей.

На Twitch есть около 110 тысяч активных трансляций [статистике просмотров ](https://streamscharts.com/overview) ежедневно.

Для того чтобы понять сколько сообщений в чат отправляют пользователи, обратимся к ресурсу, на котором указано [среднее количество сообщений в секунду](https://stats.streamelements.com/). На момент просмотра статистики среднее значение было 720 сообщений в секунду => 720 * 60 * 60 * 24 = 62.2 млн в день.

Общей информации о количестве всех подписок на все каналы в открытом доступе нет. Поэтому я проанализирвал [среднее количество просмотров](https://streamscharts.com/subscribers) на популярных каналах и среднее количество подписок на их каналы в месяц. Исходя их этого можно предположить, что примерно 6.34% от живых зрителей подписываются на канал => 0.0634 * 2.6 млн в день = 0.165 млн в день.

Говорить о количестве запросов на авторизацию - тяжело, поэтому предположим, что 60% всех ежедневных пользователей смотрящих трансялции проходит запросы авторизации => 0.6 * 2.6 млн = 1.3 млн. в день. 

**Среднее количество действий пользователей**
Тип запроса                | Среднее количество (Измеряем в млн/день)
-------------------------- | -----------------------------
Просмотр онлайн трансляции |  2.6
Отправка сообщения в чат   |  62.2 
Подписка на стримера       |  0.165
Авторизация                |  1.3

### 2.2. Технические метрики
#### 2.2.1. Сетевой трафик
##### 2.2.1.1. Входящий трафик
Ежедневно на платформе  [происходит стрмминг](https://twitchtracker.com/statistics/stream-time) 2 083 003 часов.
На twitch, можно выбрать качество просмотра трансялции, возьмём среднее из [источника](https://help.twitch.tv/s/article/broadcast-guidelines?language=ru): ```720p 60fps = 4500 кбит/с```
```
2 083 003 * 60 * 60 с * 4500 кбит/с =  3750000 Гб в сутки 
```
Из этого следует, что 3750000 - входящий трафик в сутки, который тратится на создание трансляций.

Для того чтобы расчитать нагрузку чата, возьмём вес одного символа 16 бит, а средний размер сообщения: 10 символов. Тогда 160 бит - вес в среднем одного сообщения. ``` 160 * 62 200 000 = 1,24 Гб в сутки```

Сделаем ещё одно допущение: пусть на один запрос авторизации будет весом 0.5 кб памяти. Тогда в сутки будет обрабатываться 0.26 гб. 

Информацие о подписках на стримера можно пренебречь, т.к. эти данные существенно меньше, чем входящий трафик на другие категории.

##### 2.2.1.2. Исходящий трафик
Средняя продолжительность нахождения на платформе равна 00:08:51 (531 секунда) в сутки как уже говорилось выше. Количество посетителей сайта 40 млн в день. Далеко не каждый из этих пользовтаелей проводит своё время за просмотром трансляций, будем считать, что процент смотрящих трансляции людей равен 70% от 40 млн.
```
531 c * 4500 кбит/с * 40 000 000 млн/сутки  * 0.7 = 7 656 250 Гб
```
Выходит, что 7 656 250 Гб - исходящий трафик в сутки

Исходящий трафик чата - просмотр его истории. Согласно [9](https://twitchtracker.com/statistics/active-streamers), получаем около 120 активных участников чата  в среднем. Таким образом каждый зритель трансляции создаёт трафик для просмотра чата, в которой ведут активность ~120 человек => активность одного человека, влечёт за собой 120-кратную активность со стороны других участников чата.
```
1,24 * 120 = 148.8 Гб в сутки
```
Выходит, что : исходящий трафик для чата приблизительно равен 150 Гб в сутки
#### 2.2.2. RPS
Просмотр онлайн трансляций(при обновлении счётчика 1 раз в минуту)
```
90 000 / 60 = 1500 запр. в сек.
```
Отправка сообщений согласно [[5](https://stats.streamelements.com/)] равна ```720 запр. в сек.```
Подписка на стримера
```
165 000 / 24 / 60 / 60 = 2 запр. в сек.
```
Авторизация
```
1 300 000 / 24 / 60 / 60 = 15 запр. в сек.
```

Тип запроса                | RPS
-------------------------- | -----------------------------
Просмотр онлайн трансляции |  1500
Отправка сообщения в чат   |  720 
Подписка на стримера       |  2
Авторизация                |  15

## 3. Логическая схема БД
![Логическая схема](https://i.ibb.co/zspzN2y/Untitled-Diagram-drawio-1.png)
## 4. Физическая схема БД
Все данные будут храниться в PostgreSQL. Очевидно, что количество чтений сильно превышает количество записей => стоит использовать master-slave репликацию и реплики чтения. 
Требуется использовать кеширование, для хранения и изменения информации о количестве зрителей, запросов авторизации и сообщений в чат. Для этого отлично подходит Redis - in-memory база данных
##### Расчёт данных и индексы
**Users**
```
4 + 128 + 128 + 4 + 128 + 8 + 2048 = 2448 байт
140 000 000 * 2448 = 342 720 000 000 байт = 0,34272 Тб
```

**Photos**
```
4 + 128 = 132 байт
140 000 000 * 132 = 18 480 000 000 байт = 0,01848 Тб
```

**Subscriptions**
```
3*4 = 12 байт
# Если человек в среднем имеет 15 подписчиков, то 
140 000 000 * 15 * 12 = 25 200 000 000 байт = 0,0252 Тб
```

**Streams**
Запись стрима не сохраняется
```
3*4 + 128 + 2048 + 8 = 2196 байт
# Если человек в среднем имеет 15 подписчиков, то 
2196 * 110 000 = 241 560 000 байт = 241,56 Мб
```

**Messages**
Чат привязан к стриму. Хранить сообщения и чаты в PSQL - дорогая операция, так это происходит постоянно и с большой нагрузкой => записывать историю чата(как это реализованно в Twitch сейчас) необходимости нет. Сообщения поступают через WebSocket и рассылаются всем текущим пользователям на стриме. Это можно реализовать через [Pub/Sub](https://redis.io/docs/manual/pubsub/) в Redis, т.к. не предпологается конкретного получателя сообщения и их кличество, сообщение получают все из чата.
```
на хранение затрачивается 0 байт
```
**Links**
Каждый стрим можно смотреть в 6 различных качествах от 1080p 60FPS до 160p 30FPS.
Значит под каждую запись стрима будет приходиться 6 ссылок:
```
4 + 4 + 128 = 136 байт
136 * 6 * 110 000 = 89 760 000 байт = 89,76 Мб
```

**Итог PostgresQL**
```
0,34272 Тб + 0,01848 Тб + 0,0252 Тб + 241,56 Мб + 89,76 Мб ~= 0.4 Тб
```

Поле          | Индексы
--------------| -----------------------
Users         |  id, username
Photos        |  id (dafault)
Subscriptions |  user_id, streamer_id
Streams       |  id (dafault)
Links         |  stream_id

**Redis**
**Хранение сессий** user_id + cookie 
```
140 000 000 * (4 + 32) = 5 040 000 000 байт = 5.04 Гб
```
**Счётчик зрителей на стриме** stream_id + viewers_count 
```
110 000 * (4 + 4) = 880 000 байт = 0.88 Мб
```

Ещё Redis используется для сообщений, но только рассылает их подписчикам, а не хранит.

## 5. Технологии
| Технология| Применение | Причина выбора           
| ------------ |------------------------------------ |-----------------------------------------
| TypeScript| Язык используемый для написания фронтенда| Типизация, демонстрация ошибок на момент запуска
| React | JS фреймворк для написания клиентской части| Скорость написания, быстрое проектирование интерфейсов
| Nginx| Веб-сервер для отдачи статики| Производительность, популярность, простота настройки
| Golang| Язык backend| Скорость работы, безопасность
| gRPC| Cистема удалённого вызова процедур| Удобство использования с golang, быстрота взаимоздействия микросервисов
| AWS Elemental MediaLive | Сервис обработки видео в реальном времени| Надёжность, скорость работы, вариативность
| RedisDB| in-memory База данных| Высокая скорость из-за нахождения данных в оперативной памяти
| PostgreSQL| База данных| Сравнительно легкая расширяемость


## Источники
1. https://ru.wikipedia.org/wiki/Twitch
2. https://www.similarweb.com/ru/website/twitch.tv/#traffic
3. https://www.similarweb.com/ru/website/twitch.tv/#geography
4. https://streamscharts.com/overview
5. https://stats.streamelements.com/
6. https://streamscharts.com/subscribers
7. https://twitchtracker.com/statistics/stream-time 
8. https://help.twitch.tv/s/article/broadcast-guidelines?language=ru
9. https://twitchtracker.com/statistics/active-streamers
10. https://earthweb.com/twitch-statistics/
11. https://redis.io/docs/manual/pubsub/
